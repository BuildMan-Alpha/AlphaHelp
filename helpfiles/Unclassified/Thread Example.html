	<!DOCTYPE html>
	<html>
	<head>
	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />
	<link rel="stylesheet" type="text/css" href="theme.css" />
	</head>
	<body>
	<div id="tiki-clean">
			<div id="tiki-mid">
	
 



 

	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 




<article id="top" class="wikitext clearfix nopagetitle">
			
		
		
		
		
			 

	
			

<p class=A3Topic>Thread Example</p>



<p>This is an example of using background threads. This thread is going 
 to look for a specific file.If that file is found, it will be read in 
 and executed (making the assumption that the text file is an Xbasic script). 
 If the file doesn't exist, the thread will sleep for a while before looking 
 for the file again.</p>



<p class=A5><a name=Creating_the_Thread_Code>Creating the Thread Code</a></p>



<p>Define the code that will run in the background thread.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim thread_code&nbsp;as&nbsp;C</p>


<p class=Code>thread_code = <<%code%</td></tr>
</table>

<p>The Xbasic debugger cannot be used on threads and if there is an error 
 running the script below, the thread will simply exit with no indication 
 of what the problem was. By defining an Xbasic error log inside the thread, 
 any errors will be written out to the specified file.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>xbasic_error_log("c:\thread_error.txt")</td></tr>
</table>

<p>The file we want to look for is "work_to_do.txt" in the current 
 database folder.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim looking_for&nbsp;as&nbsp;C</p>


<p class=Code>looking_for = file.filename_parse(a5.Get_Name(),"DP") 
 + "work_to_do.txt"</td></tr>
</table>

<p>Define a log file to store the results of what this thread does.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim logfile&nbsp;as&nbsp;C</p>


<p class=Code>logfile = "c:\threadlog.txt"</td></tr>
</table>

<p>Get a pointer to our own thread so we can set some options on it.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim this_thread&nbsp;as&nbsp;P</p>


<p class=Code>this_thread = thread.current()</td></tr>
</table>

<p>Set a flag that says we want to disable UI from this thread. Attempting 
 to use UI functions from a background thread will hang Alpha Five, but 
 most UI operations will check this flag first to prevent the hang.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>this_thread.ui_disable = .t.</td></tr>
</table>

<p class=Note><span class=Note><img src="images/icon_information.gif"
									x-maintain-ratio=TRUE
									style="border: none;
											width: 36px;
											height: 32px;
											float: none;
											border-style: none;
											border-style: none;"
									width=36
									height=32
									border=0>Note</span> : Starting with 
 Version 7 build 3002, this property will be set automatically for background 
 threads.</p>



<p>Set this thread's priority to a lower level. Threads with a lower priority 
 will yield to a threads with a higher priority. This will prevent this 
 thread from interfering with other work being done in this instance of 
 Alpha Five. Valid thread priorities are -2, -1, 0, 1 and 2. These are 
 "lowest", "below normal", "normal", "above 
 normal" and "highest".</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>this_thread.set_priority(-2)</td></tr>
</table>

<p>A thread will end when its script runs to completion. However, this 
 thread should keep running to monitor for new files. The solution is use 
 a while loop to keep the script from ever ending. Of course the thread 
 may need to be stopped at some point, and this can be done by changing 
 the value of the logical variable we are looping on. The details of how 
 to change the value and stop the thread are explained below.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim thread_run_flag&nbsp;as&nbsp;L = .t.</p>


<p class=Code>while thread_run_flag</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;'the file exists, so now work with 
 it...</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;if file.exists(looking_for)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dim file_contents&nbsp;as&nbsp;C</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'read in 
 the contents of the file</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_contents 
 = get_from_file(looking_for)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'delete the 
 file so it isn't found the next time through this loop</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file.remove(looking_for)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'assume the 
 file contains valid (and safe) Xbasic and execute it</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dim run_result&nbsp;as&nbsp;C</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_result 
 = evaluate_template(file_contents)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'save the 
 result to the log file</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if run_result 
 = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_result 
 = "The script ran successfully"</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end if</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save_to_file(time("0h:0h:0s") 
 + " " + run_result,logfile,.t.)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end if</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;'Tell this thread to go ahead and 
 yield to any other threads waiting to run</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;yield control</p>


<p class=Code>end while</p>


<p class=Code>%code%</td></tr>
</table>

<p class=A5><a name=Naming_the_Thread>Naming the Thread</a></p>



<p>Each thread must have a unique name. The name "Main" is reserved&nbsp;as&nbsp;it 
 is used by the main Alpha Five application.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim thread_name&nbsp;as&nbsp;C</p>


<p class=Code>thread_name = "MyThread"</td></tr>
</table>

<p class=A5><a name=Starting_the_Thread>Starting the Thread</a></p>



<p>Now that the thread code and name have been created, all that is left 
 is the actual creation of the thread.</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>thread_create(thread_name, thread_code)</td></tr>
</table>

<p class=A5><a name=Stopping_the_Thread>Stopping the Thread</a></p>



<p>This thread will now run indefinitely. To stop it at some later time, 
 use code such&nbsp;as&nbsp;the following on a button, in a script, etc..</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>dim tv&nbsp;as&nbsp;P</p>


<p class=Code>tv = thread_variables("MyThread")</p>


<p class=Code>tv.thread_run_flag = .f.</p>


<p class=Code>delete tv</td></tr>
</table>

<p>The code above can be shortened by using the explicit assignment operator: 
 ":=".</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>thread_variables("MyThread").thread_run_flag := 
 .f.</td></tr>
</table>

<p class=A5><a name=Checking_for_a_Thread_with_the_Same_Name>Checking for 
 a Thread with the Same Name</a></p>



<p>Note that the <a href="../References/Functions/THREAD_CREATE Function.html" title="THREAD_CREATE Function" class="wiki">THREAD_CREATE(</a>) 
 <span class=Code1>&nbsp;</span>above will fail with an "Error 1" 
 if the thread 'name being used to create the thread already exists. There 
 are two ways to prevent the error.Which one to use depends on whether 
 or not multiple copies 'of the same code should be allowed to run. To 
 prevent more than one copy, use code such&nbsp;as&nbsp;this before the 
 <span class=Code1>thread_create()</span>:</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>if thread_exists(thread_name)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;ui_msg_box("Error", "The 
 " + thread_name + " thread is already running", UI_STOP_SYMBOL)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>end if</td></tr>
</table>

<p class=A5><a name=Running_Multiple_Copies_of_a_Thread>Running Multiple 
 Copies of a Thread</a></p>



<p>To allow multiple copies to run, the thread name must be changed. <a href="../References/Functions/THREAD_NAME_CREATE Function.html" title="THREAD_NAME_CREATE Function" class="wiki">THREAD_NAME_CREATE(</a>) 
 will ensure that a unique thread name is generated, 'based on the base 
 name you give it and the names of the threads that are currently running.To 
 use it, the <span class=Code1>thread_create()</span> call used above would 
 be changed to:</p>




<table class="codeTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;" valign="top">
<td style="x-cell-content-align: top;
			width: 100%;
			padding-right: 10px;
			padding-left: 10px;" valign="top" width="100%">
<p class=Code>thread_create(thread_name_create(thread_name), thread_code)</td></tr>
</table>

<p>Note that in the above, the <span class=Code1>thread_name_create()</span> 
 is used inline&nbsp;as&nbsp;part of the <span class=Code1>thread_create()</span> 
 call. If the <span class=Code1>thread_name_create()</span> were to be 
 done on a separate line, and more than one thread was trying to create 
 threads, you could potentially end up with a situation where script 1 
 runs the <span class=Code1>thread_name_create()</span> and gets what it 
 thinks is a unique name, script 2 runs the <span class=Code1>thread_name_create()</span> 
 and gets what it thinks is a unique name, but in reality it is not unique 
 and matches exactly what script 1 has.Whichever script goes on to create 
 the thread first will succeed, but the second one will result in an error 
 since the thread name is no longer available. This is what is known&nbsp;as&nbsp;a 
 "race condition" and is a common pitfall in threaded programming.</p>



<p class=A5>See Also</p>



<p><a href="../References/Functions/Thread Functions and Methods.html" title="Thread Functions and Methods" class="wiki">Thread Functions   and Methods</a>, <a href="Using the Thread UI_Disable Property.html" title="Using the Thread UI_Disable Property" class="wiki">Using   the Thread UI_Disable Property</a></p>



	<hr class="hrwikibottom" /> 

	
	</article> 




	<!-- WIKIPATH:Thread+Example">-->


	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 

			</div>
		</div>


	
	
<!-- Put JS at the end -->
	
<!-- jsfile external -->


<!-- jsfile dynamic -->
<!-- jsfile 0 -->
<!---HELPMETADATA: {"group":"/Guide/Desktop/Xbasic/","status":"pending","tags":"desktop, review","notes":"version 7, only used in weird cases?","keywords":"desktop,xbasic,actionxb"} --->
</body></html>