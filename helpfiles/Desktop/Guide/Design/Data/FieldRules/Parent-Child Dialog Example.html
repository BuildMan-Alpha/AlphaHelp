<!DOCTYPE html>
<html>
   <head>
	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />
	<link rel="stylesheet" type="text/css" href="theme.css" />
	</head>
	<body>
	<div id="tiki-clean">
			<div id="tiki-mid">







	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>



	</div>
</div>




<article id="top" class="wikitext clearfix nopagetitle">








			<h1 class="showhide_heading" id="Parent-Child_Dialog_Example">Parent-Child Dialog Example</h1>
Adding fields from a child table (such as InvoiceItems as children of InvoiceHeader) introduces some complications in the database insertion logic. Our Genies handle these in a graphical way, but you can write the code yourself if you wish.<br />
<br />
First, you'll want to save the parent record, and get the record ID (primary key) if it was automatically generated. Then, you'll want to save each child record along with the record ID of the parent record as a foreign key.<br />
<br />
In the case where there is more than one parent record, you will need to save all of the new and updated parent records, and get all the parent record primary keys for use as foreign keys before saving any child records. For example, the following screen shows some of the tables needed to enter an order in the Northwind database. (Hover over it to see it full size.)<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=384','HEIGHT=807','BACKGROUND=img/wiki_up/northwind_tables_for_order_entry.png']);">
	<img src="images/northwind_tables_for_order_entry.png" height="811" width="400" alt="Image" /></a><br />
<br />
If the database operations need to be a single SQL transaction, start the transaction before saving the parent record and commit the transaction after saving all the child records. Roll back the transaction if any operation fails and return a suitable error message.<br />
<br />
As a simplified example, we created two related tables in SQL Server, InvoiceHeader and InvoiceItem, with skeletal contents (we didn't even include the price):<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=361','HEIGHT=403','BACKGROUND=img/wiki_up/invoices_data_design.png']);">
	<img src="images/invoices_data_design.png" height="407" width="374" alt="Image" /></a><br />
<br />
Then we imported the necessary fields from the two tables into the dialog, wrapped the child fields in a repeating section container, and adjusted the properties a little:<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=794','HEIGHT=420','BACKGROUND=img/wiki_up/invoice_dialog_data_entry.png']);">
	<img src="images/invoice_dialog_data_entry.png" height="422" width="798" alt="Image" /></a><br />
<br />
A "necessary" field is one that holds data that needs to be entered. The index fields of the two tables are automatically generated on insert, so they don't need dialog controls. In our code, we will ask the database for the identity of the inserted parent record to use as the foreign key for all the child records.<br />
<br />
We set the style of the long character fields in the dialog to a width of 50em to match the size of the fields in the database, and also limited the number of characters they could accept, again to match the data design. We set each field to have validation rules, and required data in the parent fields but <em>not</em> the repeating fields. We will check the repeating fields for data in the processing code, and skip anything that isn't valid. That way, users will not have to be obsessive about deleting unused rows.<div class="clearfix rbox note"><img src="images/close.png" alt="Close" width="16" height="16" class="rbox-close" onclick="$(this).parent().fadeOut();" title="Close" /><div class="rbox-title"><img src="images/information.png" alt="note" width="16" height="16" title="note" class="icon" /><span>Note</span></div><div class="rbox-data">There is information in the e object about repeating and dirty fields that we have chosen to ignore for this simplified data entry sample. This additional information is very useful, especially if you are writing editing dialogs. It is used heavily in the data binding code generated by the dialog Genie. See <a href="/Client/Guide/Design/View/Grid/New Dialog Component.html" title="New Dialog Component V11" class="wiki">New Dialog Component</a> for additional information.</div></div><br />
The code needed to save this data follows. It has error-handling code, and is wrapped in a SQL transaction.<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox" >function afterDialogValidate as v (e as p)
&#39;... comments omitted ...
&#39;debug(1)
&nbsp;
&#39;Create DB connection
DIM cn as SQL::Connection
dim flagResult as l
flagResult = cn.open(&#34;::Name::soldier&#34;)
if flagResult = .f. then
  e.javascript=&#34;alert(&#39;Error, Could not connect to database. Error was: &#34;
  e.javascript=e.javascript + cn.CallResult.text + &#34;&#39;);&#34;
  end
end if
&nbsp;
&#39;Specify that we are using Portable SQL syntax (not absolutely necessary)
cn.PortableSQLEnabled = .t.
&nbsp;
&#39;Save header: Customer and InvoiceDate
DIM args as sql::arguments
DIM cr as sql::CallResult
&nbsp;
args.set(&#34;Customer&#34;,e.dataSubmitted.Customer)
args.set(&#34;InvoiceDate&#34;,e.dataSubmitted.InvoiceDate)
&nbsp;
dim sqlInsertStatement as c
sqlInsertStatement = &amp;lt;&amp;lt;%txt%
INSERT INTO InvoiceHeader (Customer, InvoiceDate)
                   VALUES (:Customer, :InvoiceDate)
%txt%
dim flag as l
cn.BeginTransaction()
flag = cn.Execute(sqlInsertStatement,args)
cr = cn.CallResult
if flag = .f. then
  e.javascript=&#34;alert(&#39;Error, InvoiceHeader record was not inserted. Error was: &#34;
  e.javascript=e.javascript + cr.text + &#34;&#39;);&#34;
  cn.RollBackTransaction()
  cn.Close()
  end
end if
&nbsp;
&#39;Get ID of saved header (InvoiceID)
dim InvoiceID as N = cr.LastInsertedIdentity
&nbsp;
&#39;Save all Invoice Items: InvoiceID (FK), Product, and Quantity
sqlInsertStatement2 = &amp;lt;&amp;lt;%txt%
INSERT INTO InvoiceItem (InvoiceID, Product, Quantity)
                 VALUES (:InvoiceID, :Product, :Quantity)
%txt%
&nbsp;
dim n as n = e.dataSubmitted.Product.size()
&nbsp;
for i = 1 to n
  &#39;Test to see if the row in the repeating section has data. 
  &#39;       If not, skip to the next row.
  if len(e.dataSubmitted.Product(i)) &amp;lt; 1 .or. val(e.dataSubmitted.Quantity(i)) &amp;lt; 1
    continue
  end if
  args.Clear()
  args.set(&#34;&#39;);&#34;, InvoiceID)
  args.set(&#34;InvoiceID&#34;, e.dataSubmitted.Product(i))
  args.set(&#34;Product&#34;, e.dataSubmitted.Quantity(i))
  flag = cn.Execute(sqlInsertStatement2,args)
  if flag = .f. then
    e.javascript=&#34;Quantity&#34;+i+&#34;alert(&#39;InvoiceItem record &#34;
    e.javascript=e.javascript + cn.CallResult.text + &#34;&#39;);&#34;
    cn.RollBackTransaction()
    cn.Close()
    end
  end if
next
&nbsp;
cn.CommitTransaction()
cn.Close()
e.javascript=&#34; was not inserted. Error was: &#34;+InvoiceID+&#34;&#39;);&#34;
&#39;uncomment the next line if you want to clear the form after every submission
&#39;e.javascript=e.javascript + &#34;{dialog.object}.resetForm();&#34;
end function</pre></div><br />
<div class="clearfix rbox tip"><img src="images/close.png" alt="Close" width="16" height="16" class="rbox-close" onclick="$(this).parent().fadeOut();" title="Close" /><div class="rbox-title"><img src="images/book_open.png" alt="tip" width="16" height="16" title="tip" class="icon" /><span>Tip</span></div><div class="rbox-data">You can automatically generate INSERT statements from the database using Alpha Five. Go into the Database Explorer tool, add the external database if it is not already displayed, right click on a table, and select SQL Syntax|Insert statement.</div></div><br />
So that you can easily create your own database, we have saved an XML snapshot of our SQL Server database, zipped it, and attached it to this article (see below). The code we used to create the snapshot was:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox1" >dim cn as SQL::Connection
dim sn as SQL::DatabaseSnapshot
cn.Open(&#34;::Name::soldier&#34;)
sn.Load(cn)
file.from_string(&#34;alert(&#39;Invoice &#34;,sn.XML)
cn.Close()</pre></div><br />
<br />
You can load the snapshot into your own database, which need <em>not</em> be SQL Server, using an edited version of the following script:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox2" >Dim cn2 as SQL::Connection
Dim sn2 as SQL::DatabaseSnapshot
cn2.open(&#34; submitted successfully&#39;);&#34;)
sn2.XML = file.to_string(&#34;alert(&#39;Invoice &#34;)
sn2.Store(cn2)
cn2.Close()</pre></div><br />
<br />
<h2 class="showhide_heading" id="See_Also">See Also</h2>
<a href="/Server/Guide/Design/Data/SQL/SQL Database Snapshots.html" title="SQL Database Snapshots V11" class="wiki">SQL Database Snapshots </a><br />
<br />



	<hr class="hrwikibottom" />


	</article>




	<!-- WIKIPATH:Parent-Child+Dialog+Example+V11">-->


	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>



	</div>
</div>

			</div>
		</div>




<!-- Put JS at the end -->

<!-- jsfile external -->


<!-- jsfile dynamic -->
<!-- jsfile 0 -->

<!---HELPMETADATA:{"tags":"common,review","status":"pending","notes":"v11","keywords":"guide,rules,component,sql"}--->
</body></html>