<!DOCTYPE html>
<html>
   <head>
	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />
	<link rel="stylesheet" type="text/css" href="theme.css" />
	</head>
	<body>
	<div id="tiki-clean">
			<div id="tiki-mid">







	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>



	</div>
</div>




<article id="top" class="wikitext clearfix nopagetitle">








			<h1 class="showhide_heading" id="Parent-Child_Dialog_Example">Parent-Child Dialog Example</h1>
Adding fields from a child table (such as InvoiceItems as children of InvoiceHeader) introduces some complications in the database insertion logic. Our Genies handle these in a graphical way, but you can write the code yourself if you wish.<br />
<br />
First, you'll want to save the parent record, and get the record ID (primary key) if it was automatically generated. Then, you'll want to save each child record along with the record ID of the parent record as a foreign key.<br />
<br />
In the case where there is more than one parent record, you will need to save all of the new and updated parent records, and get all the parent record primary keys for use as foreign keys before saving any child records. For example, the following screen shows some of the tables needed to enter an order in the Northwind database. (Hover over it to see it full size.)<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=384','HEIGHT=807','BACKGROUND=img/wiki_up/northwind_tables_for_order_entry.png']);">	<img src="images/northwind_tables_for_order_entry.png" height="403" width="192" alt="Image" /></a><br />
<br />
If the database operations need to be a single SQL transaction, start the transaction before saving the parent record and commit the transaction after saving all the child records. Roll back the transaction if any operation fails and return a suitable error message.<br />
<br />
As a simplified example, we created two related tables in SQL Server, InvoiceHeader and InvoiceItem, with skeletal contents (we didn't even include the price):<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=361','HEIGHT=403','BACKGROUND=img/wiki_up/invoices_data_design.png']);">	<img src="images/invoices_data_design.png" height="201" width="180" alt="Image" /></a><br />
<br />
Then we imported the necessary fields from the two tables into the dialog, wrapped the child fields in a repeating section container, and adjusted the properties a little:<br />
<br />
<a href="javascript:void(0)" class="internal" onmouseover="return convertOverlib(this,'&nbsp;',['WIDTH=794','HEIGHT=420','BACKGROUND=img/wiki_up/invoice_dialog_data_entry.png']);">	<img src="images/invoice_dialog_data_entry.png" height="210" width="397" alt="Image" /></a><br />
<br />
A "necessary" field is one that holds data that needs to be entered. The index fields of the two tables are automatically generated on insert, so they don't need dialog controls. In our code, we will ask the database for the identity of the inserted parent record to use as the foreign key for all the child records.<br />
<br />
We set the style of the long character fields in the dialog to a width of 50em to match the size of the fields in the database, and also limited the number of characters they could accept, again to match the data design. We set each field to have validation rules, and required data in the parent fields but <em>not</em> the repeating fields. We will check the repeating fields for data in the processing code, and skip anything that isn't valid. That way, users will not have to be obsessive about deleting unused rows.<div class="clearfix rbox note"><img src="images/close.png" alt="Close" width="16" height="16" class="rbox-close" onclick="$(this).parent().fadeOut();" title="Close" /><div class="rbox-title"><img src="images/information.png" alt="note" width="16" height="16" title="note" class="icon" /><span>Note</span></div><div class="rbox-data">There is information in the e object about repeating and dirty fields that we have chosen to ignore for this simplified data entry sample. This additional information is very useful, especially if you are writing editing dialogs. It is used heavily in the data binding code generated by the dialog Genie. See <a href="../New Dialog Component V11.html" title="New Dialog Component V11" class="wiki">New Dialog Component V11</a> for additional information.</div></div><br />
The code needed to save this data follows. It has error-handling code, and is wrapped in a SQL transaction.<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox" ><span style="color: #0600FF;">function</span> afterDialogValidate <span style="color: #FF8000;">as</span> v <span style="color: #000000;">&#40;</span>e <span style="color: #FF8000;">as</span> p<span style="color: #000000;">&#41;</span>
<span style="color: #008080; font-style: italic;">'... comments omitted ...</span>
<span style="color: #008080; font-style: italic;">'debug(1)</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Create DB connection</span>
<span style="color: #0600FF;">DIM</span> cn <span style="color: #FF8000;">as</span> SQL::Connection
<span style="color: #0600FF;">dim</span> flagResult <span style="color: #FF8000;">as</span> l
flagResult <span style="color: #008000;">=</span> cn.<span style="color: #0600FF;">open</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;::Name::soldier&quot;</span><span style="color: #000000;">&#41;</span>
<span style="color: #0600FF;">if</span> flagResult <span style="color: #008000;">=</span> .<span style="color: #0000FF;">f</span>. <span style="color: #FF8000;">then</span>
  e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span><span style="color: #808080;">&quot;alert('Error, Could not connect to database. Error was: &quot;</span>
  e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span>e.<span style="color: #0000FF;">javascript</span> <span style="color: #008000;">+</span> cn.<span style="color: #0000FF;">CallResult</span>.<span style="color: #0000FF;">text</span> <span style="color: #008000;">+</span> <span style="color: #808080;">&quot;');&quot;</span>
  <span style="color: #0600FF;">end</span>
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Specify that we are using Portable SQL syntax (not absolutely necessary)</span>
cn.<span style="color: #0000FF;">PortableSQLEnabled</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
<span style="color: #008080; font-style: italic;">'Save header: Customer and InvoiceDate</span>
<span style="color: #0600FF;">DIM</span> args <span style="color: #FF8000;">as</span> sql::arguments
<span style="color: #0600FF;">DIM</span> <span style="color: #0600FF;">cr</span> <span style="color: #FF8000;">as</span> sql::CallResult
&nbsp;
args.<span style="color: #FF8000;">set</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Customer&quot;</span>,e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Customer</span><span style="color: #000000;">&#41;</span>
args.<span style="color: #FF8000;">set</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;InvoiceDate&quot;</span>,e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">InvoiceDate</span><span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #0600FF;">dim</span> sqlInsertStatement <span style="color: #FF8000;">as</span> c
sqlInsertStatement <span style="color: #008000;">=</span> <span style="color: #008000;">&amp;</span>lt;<span style="color: #008000;">&amp;</span>lt;%txt%
INSERT INTO InvoiceHeader <span style="color: #000000;">&#40;</span>Customer, InvoiceDate<span style="color: #000000;">&#41;</span>
                   VALUES <span style="color: #000000;">&#40;</span>:Customer, :InvoiceDate<span style="color: #000000;">&#41;</span>
%txt%
<span style="color: #0600FF;">dim</span> flag <span style="color: #FF8000;">as</span> l
cn.<span style="color: #0000FF;">BeginTransaction</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
flag <span style="color: #008000;">=</span> cn.<span style="color: #0000FF;">Execute</span><span style="color: #000000;">&#40;</span>sqlInsertStatement,args<span style="color: #000000;">&#41;</span>
<span style="color: #0600FF;">cr</span> <span style="color: #008000;">=</span> cn.<span style="color: #0000FF;">CallResult</span>
<span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">f</span>. <span style="color: #FF8000;">then</span>
  e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span><span style="color: #808080;">&quot;alert('Error, InvoiceHeader record was not inserted. Error was: &quot;</span>
  e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span>e.<span style="color: #0000FF;">javascript</span> <span style="color: #008000;">+</span> <span style="color: #0600FF;">cr</span>.<span style="color: #0000FF;">text</span> <span style="color: #008000;">+</span> <span style="color: #808080;">&quot;');&quot;</span>
  cn.<span style="color: #0000FF;">RollBackTransaction</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
  cn.<span style="color: #0600FF;">Close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
  <span style="color: #0600FF;">end</span>
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Get ID of saved header (InvoiceID)</span>
<span style="color: #0600FF;">dim</span> InvoiceID <span style="color: #FF8000;">as</span> N <span style="color: #008000;">=</span> <span style="color: #0600FF;">cr</span>.<span style="color: #0000FF;">LastInsertedIdentity</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Save all Invoice Items: InvoiceID (FK), Product, and Quantity</span>
sqlInsertStatement2 <span style="color: #008000;">=</span> <span style="color: #008000;">&amp;</span>lt;<span style="color: #008000;">&amp;</span>lt;%txt%
INSERT INTO InvoiceItem <span style="color: #000000;">&#40;</span>InvoiceID, Product, Quantity<span style="color: #000000;">&#41;</span>
                 VALUES <span style="color: #000000;">&#40;</span>:InvoiceID, :Product, :Quantity<span style="color: #000000;">&#41;</span>
%txt%
&nbsp;
<span style="color: #0600FF;">dim</span> n <span style="color: #FF8000;">as</span> n <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Product</span>.<span style="color: #0000FF;">size</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #FF8000;">for</span> i <span style="color: #008000;">=</span> <span style="color: #FF0000;">1</span> <span style="color: #FF8000;">to</span> n
  <span style="color: #008080; font-style: italic;">'Test to see if the row in the repeating section has data. </span>
  <span style="color: #008080; font-style: italic;">'       If not, skip to the next row.</span>
  <span style="color: #0600FF;">if</span> <span style="color: #FF8000;">len</span><span style="color: #000000;">&#40;</span>e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Product</span><span style="color: #000000;">&#91;</span>i<span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span> <span style="color: #008000;">&amp;</span>lt; <span style="color: #FF0000;">1</span> .<span style="color: #0000FF;">or</span>. <span style="color: #0600FF;">val</span><span style="color: #000000;">&#40;</span>e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Quantity</span><span style="color: #000000;">&#91;</span>i<span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span> <span style="color: #008000;">&amp;</span>lt; <span style="color: #FF0000;">1</span>
    continue
  <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span>
  args.<span style="color: #0000FF;">Clear</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
  args.<span style="color: #FF8000;">set</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;InvoiceID&quot;</span>, InvoiceID<span style="color: #000000;">&#41;</span>
  args.<span style="color: #FF8000;">set</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Product&quot;</span>, e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Product</span><span style="color: #000000;">&#91;</span>i<span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>
  args.<span style="color: #FF8000;">set</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;Quantity&quot;</span>, e.<span style="color: #0000FF;">dataSubmitted</span>.<span style="color: #0000FF;">Quantity</span><span style="color: #000000;">&#91;</span>i<span style="color: #000000;">&#93;</span><span style="color: #000000;">&#41;</span>
  flag <span style="color: #008000;">=</span> cn.<span style="color: #0000FF;">Execute</span><span style="color: #000000;">&#40;</span>sqlInsertStatement2,args<span style="color: #000000;">&#41;</span>
  <span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">f</span>. <span style="color: #FF8000;">then</span>
    e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span><span style="color: #808080;">&quot;alert('InvoiceItem record &quot;</span><span style="color: #008000;">+</span>i<span style="color: #008000;">+</span><span style="color: #808080;">&quot; was not inserted. Error was: &quot;</span>
    e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span>e.<span style="color: #0000FF;">javascript</span> <span style="color: #008000;">+</span> cn.<span style="color: #0000FF;">CallResult</span>.<span style="color: #0000FF;">text</span> <span style="color: #008000;">+</span> <span style="color: #808080;">&quot;');&quot;</span>
    cn.<span style="color: #0000FF;">RollBackTransaction</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
    cn.<span style="color: #0600FF;">Close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
    <span style="color: #0600FF;">end</span>
  <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span>
<span style="color: #FF8000;">next</span>
&nbsp;
cn.<span style="color: #0000FF;">CommitTransaction</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
cn.<span style="color: #0600FF;">Close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>
e.<span style="color: #0000FF;">javascript</span><span style="color: #008000;">=</span><span style="color: #808080;">&quot;alert('Invoice &quot;</span><span style="color: #008000;">+</span>InvoiceID<span style="color: #008000;">+</span><span style="color: #808080;">&quot; submitted successfully');&quot;</span>
<span style="color: #008080; font-style: italic;">'uncomment the next line if you want to clear the form after every submission</span>
<span style="color: #008080; font-style: italic;">'e.javascript=e.javascript + &quot;{dialog.object}.resetForm();&quot;</span>
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">function</span></pre></div><br />
<div class="clearfix rbox tip"><img src="images/close.png" alt="Close" width="16" height="16" class="rbox-close" onclick="$(this).parent().fadeOut();" title="Close" /><div class="rbox-title"><img src="images/book_open.png" alt="tip" width="16" height="16" title="tip" class="icon" /><span>Tip</span></div><div class="rbox-data">You can automatically generate INSERT statements from the database using Alpha Five. Go into the Database Explorer tool, add the external database if it is not already displayed, right click on a table, and select SQL Syntax|Insert statement.</div></div><br />
So that you can easily create your own database, we have saved an XML snapshot of our SQL Server database, zipped it, and attached it to this article (see below). The code we used to create the snapshot was:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox1" ><span style="color: #0600FF;">dim</span> cn <span style="color: #FF8000;">as</span> SQL::Connection
<span style="color: #0600FF;">dim</span> sn <span style="color: #FF8000;">as</span> SQL::DatabaseSnapshot
cn.<span style="color: #0600FF;">Open</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;::Name::soldier&quot;</span><span style="color: #000000;">&#41;</span>
sn.<span style="color: #0000FF;">Load</span><span style="color: #000000;">&#40;</span>cn<span style="color: #000000;">&#41;</span>
<a target="_blank" href="http://www.google.com/search?q=FILE+site:msdn.microsoft.com"><span style="color: #008000;">file</span></a>.<span style="color: #0000FF;">from_string</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;invoicedb.xml&quot;</span>,sn.<span style="color: #0000FF;">XML</span><span style="color: #000000;">&#41;</span>
cn.<span style="color: #0600FF;">Close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span></pre></div><br />
<br />
You can load the snapshot into your own database, which need <em>not</em> be SQL Server, using an edited version of the following script:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox2" ><span style="color: #0600FF;">Dim</span> cn2 <span style="color: #FF8000;">as</span> SQL::Connection
<span style="color: #0600FF;">Dim</span> sn2 <span style="color: #FF8000;">as</span> SQL::DatabaseSnapshot
cn2.<span style="color: #0600FF;">open</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;::Name::MyTargetDatabase&quot;</span><span style="color: #000000;">&#41;</span>
sn2.<span style="color: #0000FF;">XML</span> <span style="color: #008000;">=</span> <a target="_blank" href="http://www.google.com/search?q=FILE+site:msdn.microsoft.com"><span style="color: #008000;">file</span></a>.<span style="color: #0000FF;">to_string</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;invoicedb.xml&quot;</span><span style="color: #000000;">&#41;</span>
sn2.<span style="color: #0000FF;">Store</span><span style="color: #000000;">&#40;</span>cn2<span style="color: #000000;">&#41;</span>
cn2.<span style="color: #0600FF;">Close</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span></pre></div><br />
<br />
<h2 class="showhide_heading" id="See_Also">See Also</h2>
<a href="../../../SQL Database Snapshots V11.html" title="SQL Database Snapshots V11" class="wiki">SQL Database Snapshots V11</a><br />
<br />



	<hr class="hrwikibottom" />


	</article>




	<!-- WIKIPATH:Parent-Child+Dialog+Example+V11">-->


	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>



	</div>
</div>

			</div>
		</div>




<!-- Put JS at the end -->

<!-- jsfile external -->


<!-- jsfile dynamic -->
<!-- jsfile 0 -->

<!---HELPMETADATA: {"tags":"common,review","group":"/Guides","status":"pending","notes":"v11","keywords":"guide,rules,component,sql"} --->
</body></html>