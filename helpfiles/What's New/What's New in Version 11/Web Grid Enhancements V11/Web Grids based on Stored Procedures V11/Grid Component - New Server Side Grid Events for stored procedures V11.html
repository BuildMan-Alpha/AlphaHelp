	<!DOCTYPE html>
	<html>
	<head>
	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />
	<link rel="stylesheet" type="text/css" href="theme.css" />
	</head>
	<body>
	<div id="tiki-clean">
			<div id="tiki-mid">
	
 



 

	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 




<article id="top" class="wikitext clearfix nopagetitle">
			
		
		
		
		
			 

	
			<h1 class="showhide_heading" id="Grid_Component_-_New_Server_Side_Grid_Events_for_stored_procedures">Grid Component - New Server Side Grid Events for stored procedures</h1>
The following new server-side events for Grids based on SQL tables have been added:<br />
<ul><li>onSQLCountQuery
</li><li>onSQLSelectQuery
</li><li>onSQLSummaryValuesQuery
</li><li>onSQLRefreshRowQuery
</li></ul>These events make it possible to base a Grid on a stored procedure. However, while the events are primarily of use for Grids based on stored procedures, they can still be used for SQL Grids that are based on tables, views, or custom SQL queries.<br />
<br />
Each of the events is discussed in more detail below.<br />
<br />
<h2 class="showhide_heading" id="onSQLCountQuery">onSQLCountQuery</h2>
Each time the Grid is rendered, it executes a query to compute the number of records that are shown in the Grid. This event fires just before the count query is executed. You can add an event handler for this event to compute the record count yourself and tell Alpha Five not to try to compute the count itself.<br />
<br />
IMPORTANT: If your Grid is based on a stored procedure then you <em>must</em> define code for this event as Alpha Five will not be able to get the count of the number of records itself.<br />
<br />
If your event handler takes over the responsibility of computing the record count, it must set these properties:<br />
<br />
e.count - set to the record count<br />
<br />
e.handled = .t. - indicates that the count has been computed and Alpha Five should not execute the count query that it has computed.<br />
<br />
Here is a sample onSQLCountQuery event handler that you might write:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox" ><span style="color: #0600FF;">function</span> onSQLCountQuery <span style="color: #FF8000;">as</span> v <span style="color: #000000;">&#40;</span>e <span style="color: #FF8000;">as</span> p<span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Note: a full list of the properties of the passed in 'e' object can be</span>
<span style="color: #008080; font-style: italic;">'obtained in the Grid builder in the sample function prototype for this</span>
<span style="color: #008080; font-style: italic;">'event.</span>
&nbsp;
    <span style="color: #0600FF;">dim</span> flag <span style="color: #FF8000;">as</span> l
&nbsp;
    flag <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;exec myCountStoredProcedure @city=:whatcity&quot;</span>,e.<span style="color: #0000FF;">arguments</span><span style="color: #000000;">&#41;</span>
&nbsp;
    <span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>. <span style="color: #FF8000;">then</span> 
&nbsp;
        <span style="color: #0600FF;">dim</span> rs <span style="color: #FF8000;">as</span> sql::resultset
&nbsp;
        rs <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">resultset</span>
&nbsp;
        e.<span style="color: #0000FF;">count</span> <span style="color: #008000;">=</span> rs.<span style="color: #0000FF;">data</span><span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#41;</span>
&nbsp;
        e.<span style="color: #0000FF;">handled</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
    <span style="color: #FF8000;">else</span>
&nbsp;
        e.<span style="color: #0000FF;">fatalError</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
        <span style="color: #0000FF;">e</span>.<span style="color: #0000FF;">errorText</span> <span style="color: #008000;">=</span> <span style="color: #808080;">&quot;Could not get record count. &quot;</span> <span style="color: #008000;">+</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">callResult</span>.<span style="color: #0000FF;">text</span>
&nbsp;
    <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span> 
&nbsp;
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">function</span></pre></div><br />
<br />
In the above example, the following assumptions were made:<br />
<br />
<ul><li>The stored procedure is for SQL Server, so the syntax used is appropriate for SQL Server.
</li><li>The stored procedure is called 'myCountStoredProcedure' and it takes a single parameter '@city'.
</li><li>The Grid has a Search Part that allows the user to search by city and the e.arguments object that is passed in has an argument called 'whatcity' which we bind to the stored procedure's '@city' parameter.
</li><li>The resultset returned by the stored procedure has a single row and column with the record count in it. We set e.count to the value in the first row and first column.
</li><li>We set e.handled = .t. to tell Alpha Five that the count has been computed.
</li></ul>Note: One of the properties passed in with the 'e' object is e.sql. This is the SQL that Alpha Five will parse to convert into a count query in order to compute the record count IF e.handled is NOT SET TO .t.. Your event handler can actually modify the value in e.sql, or any of the values in e.arguments should you wish to for any reason.<br />
<h2 class="showhide_heading" id="onSQLSelectQuery">onSQLSelectQuery</h2>
Each time the Grid is rendered it executes a SQL query to get a resultset of data to display in the Grid. This event fires before the select query is executed. You can add an event handler to this event to compute the resultset yourself and tell Alpha Five not to try to to get the resultset itself.<br />
<br />
IMPORTANT: If your Grid is based on a stored procedure then you <em>must</em> define code for this event.<br />
<br />
If your event handler takes over the responsibility of computing the resultset, it must set these properties:<br />
<br />
e.rs - the resultset to display in the Grid<br />
<br />
e.handled  = .t. - indicates that the resultset has been computed and that Alpha Five should not execute the select query that it has computed.<br />
<br />
Here is a sample onSQLSelectQuery event handler that you might write:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox1" ><span style="color: #0600FF;">function</span> onSQLSelectQuery <span style="color: #FF8000;">as</span> v <span style="color: #000000;">&#40;</span>e <span style="color: #FF8000;">as</span> p<span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Note: a full list of the properties of the passed in 'e' object can be</span>
<span style="color: #008080; font-style: italic;">'obtained in the Grid builder in the sample function prototype for this</span>
<span style="color: #008080; font-style: italic;">'event.</span>
&nbsp;
    <span style="color: #0600FF;">dim</span> flag <span style="color: #FF8000;">as</span> l
&nbsp;
    flag <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;exec mySelectStoredProcedure @city=:whatcity&quot;</span>,e.<span style="color: #0000FF;">arguments</span><span style="color: #000000;">&#41;</span>
&nbsp;
    <span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>. <span style="color: #FF8000;">then</span>
&nbsp;
        <span style="color: #0600FF;">dim</span> rs <span style="color: #FF8000;">as</span> sql::resultset
&nbsp;
        e.<span style="color: #0000FF;">rs</span> <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">resultset</span>
&nbsp;
        e.<span style="color: #0000FF;">handled</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
    <span style="color: #FF8000;">else</span>
&nbsp;
        e.<span style="color: #0000FF;">fatalError</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
        <span style="color: #0000FF;">e</span>.<span style="color: #0000FF;">errorText</span> <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">callresult</span>.<span style="color: #0000FF;">text</span>
&nbsp;
    <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span> 
&nbsp;
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">function</span></pre></div><br />
<br />
In the above example, the resultset that was returned was positioned at the first record. Alpha Five will then navigate in the resultset to the correct starting record to display (for example, you might have requested to show page 3 of the Grid).<br />
<br />
However, your stored procedure might be able to 'chunk' the records more efficiently than Alpha Five, and so in addition to the e.handled property you can also set the e.paginationHandled handled property to .t..<br />
<br />
The 'e' object that is passed into the onSQLSelectQuery event handler contains the following properties which would be useful if you wanted to handle the pagination of the resultset yourself in the event handler:<br />
<br />
<ul><li>e.recordCount - number of records in the Grid query
</li><li>e.targetPage - the page number of records to be shown
</li><li>e.targetLogicalRecord - the logical record number of the first record to be shown (e.g. if targetPage is 3 and records per page is 10, then targetLogicalRecord is 21)
</li><li>e.rowCount - the number of records per page to show in the Grid
</li><li>e.pageCount - the number of pages that the Grid contains. (e.g. if the grid contains 25 records and there are 10 records per page, pageCount is 3)
</li></ul><h2 class="showhide_heading" id="onSQLSummaryValuesQuery">onSQLSummaryValuesQuery</h2>
If you have turned on summary values for any of the columns in the Grid, then this event will fire when Alpha Five needs to compute the summary values to display in the Grid. Your event handler can take over the responsibility for computing these summary values.<br />
<br />
IMPORTANT: If your Grid is based on a stored procedure, and your Grid displays summary values, then you <em>must</em> write code for this event to compute the summary values.<br />
<br />
For example, say that your Grid has a column called 'Quantity' and you are displaying the count and average for this column.<br />
<br />
Here is a sample event handler you might create:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox2" ><span style="color: #0600FF;">function</span> onSQLSummaryValuesQuery <span style="color: #FF8000;">as</span> v <span style="color: #000000;">&#40;</span>e <span style="color: #FF8000;">as</span> p<span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Note: a full list of the properties of the passed in 'e' object can be</span>
<span style="color: #008080; font-style: italic;">'obtained in the Grid builder in the sample function prototype for this</span>
<span style="color: #008080; font-style: italic;">'event.</span>
&nbsp;
    <span style="color: #0600FF;">dim</span> flag <span style="color: #FF8000;">as</span> l 
&nbsp;
    flag <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;exec mySummaryValuesStoredProcedure @city = :whatcity&quot;</span>,e.<span style="color: #0000FF;">arguments</span><span style="color: #000000;">&#41;</span>
&nbsp;
    <span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>. <span style="color: #FF8000;">then</span>
&nbsp;
        <span style="color: #0600FF;">dim</span> rs <span style="color: #FF8000;">as</span> sql::resultset
&nbsp;
        rs <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">resultset</span>
&nbsp;
        e.<span style="color: #0000FF;">summary</span>.<span style="color: #0000FF;">Quantity</span>.<span style="color: #0000FF;">average</span> <span style="color: #008000;">=</span> rs.<span style="color: #0000FF;">data</span><span style="color: #000000;">&#40;</span><span style="color: #FF0000;">1</span><span style="color: #000000;">&#41;</span>
        e.<span style="color: #0000FF;">summary</span>.<span style="color: #0000FF;">Quantity</span>.<span style="color: #0000FF;">count</span> <span style="color: #008000;">=</span> rs.<span style="color: #0000FF;">data</span><span style="color: #000000;">&#40;</span><span style="color: #FF0000;">2</span><span style="color: #000000;">&#41;</span>
&nbsp;
        e.<span style="color: #0000FF;">handled</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
    <span style="color: #FF8000;">else</span>
&nbsp;
        e.<span style="color: #0000FF;">fatalError</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
        <span style="color: #0000FF;">e</span>.<span style="color: #0000FF;">errorText</span> <span style="color: #008000;">=</span> <span style="color: #808080;">&quot;Could not get summary values.&quot;</span> <span style="color: #008000;">+</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">callResult</span>.<span style="color: #0000FF;">text</span>
&nbsp;
    <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span> 
&nbsp;
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">function</span></pre></div><br />
<br />
<br />
<br />
<h2 class="showhide_heading" id="onSQLRefreshRowQuery">onSQLRefreshRowQuery</h2>
Executes whenever the data in the current row of the Grid needs to be refreshed. Your event handler can take over the responsibility of returning a resultset that contains the data for the current Grid row.<br />
<br />
IMPORTANT: If your Grid is based on a stored procedure you <em>must</em> write code for this event to return a resultset for the current Grid row. The primary key for the current Grid row will be passed into the event handler.<br />
<br />
The 'e' object that is passed into the event handler contains the value of each primary key column for the current row.<br />
<br />
For example, say that the primary key for the table that the Grid is based on is based on two columns. You can get the value of each primary key column using this code:<br />
<br />
e.arguments[e.arguments.argumentNumber("PKValue_1")].data<br />
<br />
e.arguments[e.arguments.argumentNumber("PKValue_2")].data<br />
<br />
Here is a sample event handler your might create:<br />
<br />
<div class="plugincode" parse="vbnet"><pre class="codelisting" data-syntax="vbnet" dir="ltr" style="overflow:auto;" id="codebox3" ><span style="color: #0600FF;">function</span> onSQLRefreshRowQuery <span style="color: #FF8000;">as</span>  v <span style="color: #000000;">&#40;</span>e <span style="color: #FF8000;">as</span> p<span style="color: #000000;">&#41;</span>
&nbsp;
<span style="color: #008080; font-style: italic;">'Note: a full list of the properties of the passed in 'e' object can be</span>
<span style="color: #008080; font-style: italic;">'obtained in the Grid builder in the sample function prototype for this</span>
<span style="color: #008080; font-style: italic;">'event.</span>
&nbsp;
    <span style="color: #0600FF;">dim</span> flag <span style="color: #FF8000;">as</span> l 
&nbsp;
    flag <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">execute</span><span style="color: #000000;">&#40;</span><span style="color: #808080;">&quot;exec myRefreshRowStoredProcedure @pkvalue = :PKValue_1&quot;</span><span style="color: #000000;">&#41;</span>
&nbsp;
    <span style="color: #0600FF;">if</span> flag <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>. <span style="color: #FF8000;">then</span> 
&nbsp;
        <span style="color: #0600FF;">dim</span> rs <span style="color: #FF8000;">as</span> sql::resultset
&nbsp;
        rs <span style="color: #008000;">=</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">resultset</span>
&nbsp;
        e.<span style="color: #0000FF;">handled</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
    <span style="color: #FF8000;">else</span>
&nbsp;
        e.<span style="color: #0000FF;">fatalError</span> <span style="color: #008000;">=</span> .<span style="color: #0000FF;">t</span>.
&nbsp;
        <span style="color: #0000FF;">e</span>.<span style="color: #0000FF;">errorText</span> <span style="color: #008000;">=</span> <span style="color: #808080;">&quot;Could not refresh row. &quot;</span> <span style="color: #008000;">+</span> e.<span style="color: #0000FF;">cn</span>.<span style="color: #0000FF;">callResult</span>.<span style="color: #0000FF;">text</span>
&nbsp;
    <span style="color: #0600FF;">end</span> <span style="color: #0600FF;">if</span> 
&nbsp;
<span style="color: #0600FF;">end</span> <span style="color: #0600FF;">function</span></pre></div><br />
<br />
<br />

	
	
	<hr class="hrwikibottom" /> 

	
	</article> 




	<!-- WIKIPATH:Grid+Component+-+New+Server+Side+Grid+Events+for+stored+procedures+V11">-->


	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 

			</div>
		</div>


	
	
<!-- Put JS at the end -->
	
<!-- jsfile external -->


<!-- jsfile dynamic -->
<!-- jsfile 0 --></body></html>