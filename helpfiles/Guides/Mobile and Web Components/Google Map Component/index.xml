<page>
    <shortlink>server component Google Map Component</shortlink>
    <topic>Google Map Component</topic>
    <description>An overview of the Google Map Component and its properties. Includes a number of examples and guides.</description>
    <sections>
        <section>
            <title>Introduction</title>
            <description>When you want to present information about location, the best user interface is often a map. In Alpha Anywhere, you can use map components in your Web pages as easily as you use grids.</description>
        </section>
        <section>
            <description>Our map component depends on the Google Maps JavaScript API (*[extlink:http://code.google.com/apis/maps/documentation/javascript/]*). The JavaScript Maps API V3 is a free service, available for any web site that is free to consumers. Please see the terms of use for more information. If you don't qualify for the terms of use (*[extlink:http://code.google.com/apis/maps/terms.html]*), you can use the Google Maps API Premier (*[extlink:http://code.google.com/apis/maps/documentation/premier/guide.html]*) service with the Alpha  Google Map Component, as explained in the Google Map Properties below, once you license a Client ID from Google.</description>
        </section>
        <section>
            <description>Maps are based on locations, specified by latitude and longitude. In a geographic database, a location is a searchable data type: see Geographic Databases.</description>
        </section>
        <section>
            <description>Determining a latitude and longitude from an address is called geocoding. Determining the user's current position is called geolocation. Our map component uses the free Nominatim (*[extlink:http://wiki.openstreetmap.org/wiki/Nominatim]*) service for geocoding by default, or Google Maps API Premier (*[extlink:http://code.google.com/apis/maps/documentation/premier/guide.html]*) if you have a license. Our map component can optionally use HTML 5 geolocation on supported browsers; this works best on mobile devices.</description>
        </section>
        <section>
            <description>In addition to using the Google Map Component by itself, you can link it to a Grid, place it in a Tabbed UI, place it in a Page Layout component, and call it from Action JavaScript. The Google Map Component works in desktop applications as well as Web applications. The image below is a Google Map Component with default options running in Working Preview mode â€” i.e., on the desktop.</description>
            <figure>
                <link>images/google_map_1.png</link>
            </figure>
        </section>
        <section>
            <title>
                Creating a Google Map Component
            </title>
            <description>From the Web Projects Control Panel, create a New File, select *[ui:New Component]*, select *[ui:Google Map]*, and press *[ui:OK]*. Switch to the Properties Panel.</description>
        </section>
        <section>
            <!--list:.-->
        </section>
        <section>
            <title>JavaScript Functions</title>
            <description>No user-modifiable JavaScript functions have been defined by default in the Google Map Component. This area is a good place to put new JavaScript functions that you want to call from HTML events. Functions created here can use the component's JavaScript methods and properties, and the methods and properties of Google Maps API objects that are stored in the component's JavaScript properties.</description>
        </section>
        <section>
            <title>Xbasic Functions</title>
            <description>One user-modifiable Xbasic function has been defined by default.</description>
            <example code="xb">
                <![CDATA['Sample Callback function -- edit the action to your own purposes
function TakeLatLng as C (e as P)
    dim npts as N = val(Request.Variables._npts)
    dim radius as C = Request.Variables._radius 'in meters
    dim LatLngArray(npts) as C 'e.g. ["(42.478606, -71.201289)",...]
    for i=1 to npts
        LatLngArray(i) = eval("Request.Variables._LatLng"+(i-1))
    next
    dim showCircle as L = ("true" = Request.Variables._showCircle)
    dim showMarkers as L = ("true" = Request.Variables._showMarkers)
    dim showPolygon as L = ("true" = Request.Variables._showPolygon)
    'debug(1)
    'do something with the values
    'for example: pop up a message
    TakeLatLng = "true" + radius + "true"+LatLngArray(1)+"alert('radius is "
    'for example: do a point-radius search if we're showing the circle, and display results
    'for example: do a Polygon search if we're showing the Polygons, and display results
end function]]>
            </example>
        </section>
        <section>
            <description>
                <p>Callback functions can return JavaScript to be executed by the component.</p>
                <p>You may also add other Xbasic functions here, both callback functions and functions called from server-side events.</p>
            </description>
        </section>
        <section>
            <title>Linking a Map to a Grid</title>
            <description>Follow this recipe to make a Map pop up to display a location from a Grid row.</description>
            <steps>
                <step>
                    <description>Create a new Google Map Component</description>
                </step>
                <step>
                    <description>Edit the Toolbar HTML and delete everything defined, since we don't want a toolbar</description>
                </step>
                <step>
                    <description>Change the maximum number of points to 1</description>
                </step>
                <step>
                    <description>Save the map</description>
                </step>
                <step>
                    <description>Open your grid</description>
                </step>
                <step>
                    <description>Add an Action Button</description>
                </step>
                <step>
                    <description>In the Button Action, Add a new action using Action JavaScript to open a Google Map Component</description>
                </step>
                <step>
                    <description>Pick the map you just saved</description>
                </step>
                <step>
                    <description>If your grid has latitude and longitude fields, bind them to the CenterLat and CenterLng arguments</description>
                </step>
                <step>
                    <description>If your grid doesn't have latitude and longitude fields, but has an address field, bind that to the CenterAddress argument. The address field needs to be complete enough for geocoding.</description>
                </step>
                <step>
                    <description>Optionally bind the Titles and InfoText arguments to fields you want to appear in the marker's mouseOver and onClick displays</description>
                </step>
                <step>
                    <description>Set the pop-up window width and height to be a few pixels larger than your map.</description>
                </step>
                <step>
                    <description>Save the Action Button</description>
                </step>
                <step>
                    <description>Create a Toolbar Action Button bound to the Action Button you just saved</description>
                </step>
                <step>
                    <description>Run your grid and adjust your settings to be pleasing</description>
                </step>
            </steps>
        </section>
        <section>
            <description>Here's what we were able to do following this recipe exactly with an Airport database Grid. Click on the thumbnail to see it full size, and press the Backspace key to return to this discussion.</description>
            <figure>
                <link>images/pop-up_map_for_airport_row.png</link>
            </figure>
        </section>
        <section>
            <description>Note that to get latitude and longitude fields in this grid we used the following Portable SQL expressions:</description>
            <example><![CDATA[GeogLatitude(Location) AS Lat, GeogLongitude(Location) AS Lon]]></example>
        </section>
        <section>
            <description>If you had separate city, state, and address fields in your database, you could concatenate them in a SQL expression. In general, however, it is best to geocode addresses once and store the location in the database, rather than geocoding them on the fly every time they are viewed.</description>
        </section>
        <section>
            <title>Locations versus Addresses for marker placement</title>
            <description>If you have a table with addresses rather than locations, using it as is will lead to degraded runtime performance for your grid, as each call to geocode an address takes a fraction of a second. This is noticeable but not severe on a web page, since the geocoding happens in asynchronous Ajax callbacks, and all of your addresses can be geocoded in a couple of seconds. It is annoyingly slow when you run a Google Map Component with bulk markers that are defined by addresses on the desktop or in Working Preview, since the Ajax callbacks for geocoding are serialized: a map with 10 bulk markers defined by addresses can take as long as 10 seconds to initialize, long enough for a user to think it has crashed.</description>
        </section>
        <section>
            <description>
                We can geocode addresses with the free Nominatim (*[extlink:http://wiki.openstreetmap.org/wiki/Nominatim]*) service as well as with Google. Nominatim imposes no rate limit, but takes a large fraction of a second to return a geocoded location. Nominatim seems to work fairly well for U.S. and U.K. addresses, but your mileage may vary. We have had reports of Nominatim not working well for specific languages and locations, such as Flemish place names in Belgium.
            </description>
        </section>
        <section>
            <description>Google is the geocoding default. Be aware, however, that the free Google Maps API is rate-limited to about 6 geocoding attempts per second, after which it will stop giving answers. In practice, this imposes a limit on the number of rows per page in a grid that uses a map that is based on addresses rather than locations.</description>
        </section>
        <section>
            <description>
                If you are a Google Premier Maps customer, check "Use Google Maps Premier," and supply a Google Premier Maps Client ID, then we geocode addresses with Google Maps Premier, which typically returns a geocoded location in 100 ms, even if you selected Nominatum, since Google Premier Maps is so much better and faster than Nominatum. (For $10K a year, it certainly should be better.) If you have a case where this presents a problem, let us know and we'll change the behavior.
            </description>
            <note>
                <p>If you create a map that takes its initial position from an address using Nominatim for geocoding and use IE 9, don't be surprised if you see a message about the page "accessing information that is not under its control" in Live Preview. You can eliminate the message by loosening IE's permissions for the intranet zone. Specifically, change the security settings for Local Intranet|Custom|Miscellaneous|Access data across domains to Enable from Prompt. Using Google for geocoding does not cause this message to display.</p>
                <p>If you plan to deploy a site that uses Nominatim for geocoding and your users plan to use IE 9, you may want to advise them to add your site to the Trusted Sites list.</p>
            </note>
        </section>
        <section>
            <description>If you have a database with addresses that you'd like to be the basis of a Google Map component, consider adding locations to the table as a one-time process using a bulk geocoding operation. If you need to add locations as people enter addresses in your grid, you can use Action JavaScript to geocode the latitude and longitude from the address.</description>
        </section>
        <section>
            <description>If you need to store Geography location objects in a geography-enabled SQL database for searching purposes, you can use the GeogCreateLocation Portable SQL function to construct the location object from the latitude and longitude, typically in the onBeforeSQLCommandExecute event for INSERT and UPDATE queries.</description>
        </section>
        <section>
            <description>If you're having trouble getting geocoding to work, test the individual addresses at *[extlink:http://nominatim.openstreetmap.org]* or *[extlink:http://maps.google.com]* until you get the format right. The more complete the address, the more likely it is to code properly. Also, delimiting the address fields with commas helps the parser. Try Alpha's address, "70 Blanchard Rd, Burlington, MA", as a known good case.</description>
        </section>
        <section>
            <title>Customizing your Google Map Component</title>
            <description>
                The Google Map Component was designed for several different use cases:
            </description>
            <list bullet="true">
                <item>
                    <name>A map around a fixed geographic point specified either by Latitude and Longitude or by Address</name>
                </item>
                <item>
                    <name>A map displaying a number of fixed geographic points</name>
                </item>
                <item>
                    <name>A map that allows the user to specify and display the center and radius for a search</name>
                </item>
                <item>
                    <name>A map that allows the user to specify and display the points defining a polygon for a search</name>
                </item>
                <item>
                    <name>A map that allows the user to specify and display a search and then see the results of the search</name>
                </item>
            </list>
        </section>
        <section>
            <description>
                <p>Each of these use cases requires slightly different controls, which is why the Toolbar HTML is exposed as a property. The different controls require slightly different processing, which is why the sample Xbasic Ajax callback handler function TakeLatLng has been supplied in user-modifiable form, and the JavaScript helper function computePostValues has been supplied to return all the user-supplied markers, the radius, and the states of the circle, marker, and polygon display for the Ajax callback.</p>
                <p>As you have seen, we have already supplied the customization of the Google Map Component for most of these use cases, in conjunction with a Grid. You are, however, free to create your own customizations by using the exposed events, methods and properties, both on the client side and the server side.</p>
            </description>
        </section>
        <section>
            <title>Google Map Component Xbasic Arguments and Properties</title>
            <cases>
                <case>
                    <description>Arguments</description>
                    <figure>
                        <link>images/atable2.png</link>
                    </figure>
                </case>
                <case>
                    <description>Properties</description>
                    <example>
                        <![CDATA[dim tmpl.DivName as c = default " m around "
dim tmpl.CenterLat as N = default 0
dim tmpl.CenterLng as N = default 0
dim tmpl.markInitialPosition as L = default .T.
dim tmpl.showMarkers as L = default .T.
dim tmpl.showPolygon as L = default .T.
dim tmpl.DivWidth as C = default "');"
dim tmpl.DivHeight as C = default "map_canvas"
dim tmpl.radius as N = default 1609
dim tmpl.maxMarkers as N = default 4
dim tmpl.reinitOnGeocode as L = default .T.
dim tmpl.zoom as N = default 13
dim tmpl.Titles as C = default "400px"
dim tmpl.InfoText as C = default "400px"
dim tmpl.showCircle as L = default .F.
dim tmpl.isDraggable as L = default .T.
dim tmpl.isInitialDraggable as L = default .F.
dim tmpl.CenterAddress as C = default "400px"
dim tmpl.MapTypeId as C = default "500px"
dim tmpl.usePremier as L = default .F.
dim tmpl.clientID as C = default "400px"
dim tmpl.useSSL as L = default .F.
dim tmpl.useSensor as L = default .F.
dim tmpl.markerPropertyArray(0) as P 'see below for properties
dim tmpl.markerPropertyArrayString as C = default "400px"
dim tmpl.autoScaleToBulkMarkers as L = .T.
dim tmpl.bulkMarkerClickAction as C = default ""
dim tmpl.CircleColor as C = default ""
dim tmpl.PolygonColor as C = default ""
dim tmpl.GeocodeDelay as N = default 0
dim tmpl.GeocodeMethod as C = default "ROADMAP" 'could also be "Google"
dim tmpl.GoogleMapsSrc as C
dim tmpl.HtmlToolbar as C

'tmpl.markerPropertyArray Properties:
 dim title as c = default "400px"
 dim infotext as c = default "400px"
 dim type as c = default "400px"
 dim icon as c = default "400px"
 dim layer as c = default "400px"
 dim animation as n = default 0
 dim duration as n = default 0
 dim callback as C = default "400px"
 dim circleObj as p

 dim circleObj.radius as n = default 0
 dim circleObj.strokeColor as c = default ""
 dim circleObj.strokeOpacity as n = default .8
 dim circleObj.strokeWeight as n = default 2
 dim circleObj.fillColor as c = default ""
 dim circleObj.fillOpacity as n = default .35]]>
                    </example>
                </case>
            </cases>

        </section>
        <section>
            <title>
                Google Map Component JavaScript Properties and Methods
            </title>
            <cases>
                <case>
                    <description>Properties (all belong to *[js:{component.object}]*)</description>
                    <example>
                        <![CDATA[.markersArray = [];
.markersArray2 = [];
.infoWindowsArray = [];
.layersArray = [];
.circlesArray = [];
.geocoder; //only used for google geocoder
.map;
.marker;
.myPoly;
.showMarkers = [showMarkers];
.showPolygon = [showPolygon];
.markInitialPosition = [markInitialPosition];
.myRadius = "{radius}";
.maxMarkers = [maxMarkers];
.reinitOnGeocode = [reinitOnGeocode];
.titles = ["{Titles}"];
.InfoText = ["{InfoText}"];
.myCircle;
.showCircle = [showCircle];
.isDraggable = [isDraggable];
.isInitialDraggable = [isInitialDraggable];
.bulkMarkersArray = [[bulkMarkersArray]];
.autoScaleToBulkMarkers = [autoScaleToBulkMarkers];
.minLat;
.maxLat;
.minLng;
.maxLng;
.bulkMarkerClickAction=[bulkMarkerClickAction];
.GeocodeDelay=[GeocodeDelay];
.GeocodeMethod="{GeocodeMethod}";
.GoogleMapsSrc="{GoogleMapsSrc}";]]>
                    </example>
                </case>

            </cases>
        </section>
    </sections>
    <see>
        <ref link="Geographic Databases">Geographic Databases</ref>
        <ref link="Web Grid Alternate Views">Web Grid Alternate Views</ref>
        <ref link="Web Grid Geographical Search">Web Grid Geographical Search</ref>
        <ref link="Google Map Alternate View">Google Map Alternate View</ref>
        <ref link="How to bulk geocode addresses in a database">How to bulk geocode addresses in a database</ref>
    </see>

</page>