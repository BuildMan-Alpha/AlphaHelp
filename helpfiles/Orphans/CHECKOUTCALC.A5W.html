	<!DOCTYPE html>
	<html>
	<head>
	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />
	<link rel="stylesheet" type="text/css" href="theme.css" />
	</head>
	<body>
	<div id="tiki-clean">
			<div id="tiki-mid">
	
 



 

	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 




<article id="top" class="wikitext clearfix nopagetitle">
			
		
		
		
		
			 

	
			<p class=A3Topic>CHECKOUTCALC.A5W</p>



<p class=A5>Purpose</p>



<p>The CHECKOUTCALC.A5W page performs the final processing of an order. 
 It updates tables, generates an invoice, optionally prints the invoice 
 for the customer, and subtracts the items sold from inventory.</p>



<p class=A5>Description</p>



<p>The CHECKOUTCALC.A5W page does all of the processing to complete a sale. 
 It runs in the MainFrame or body section of a frameset. The top section 
 of the frameset loads first and shows a message that the page is processing.</p>



<p>If the customer checkout process is complete and there are no errors, 
 CHECKOUTCALC.A5W page does the processing to read the data from the shopping 
 cart and complete a sale.</p>



<p>CHECKOUTCALC.A5W includes Xbasic code to save data to the <span class=Code1>customer</span>, 
 <span class=Code1>invoice_header</span>, and <span class=Code1>invoice_items</span> 
 tables. It also includes code to post the quantity sold to the <span class=Code1>product</span> 
 table to update the quantity in stock.</p>



<p>This page includes sample code that illustrates how to use <a href="../References/Objects/AuthorizeNet_Transaction.html" title="AuthorizeNet_Transaction" class="wiki">&lt;span   class=Screen&gt;Authorize.Net&lt;/span&gt;</a> to validate credit card or electronic 
 check transactions.</p>



<p>CHECKOUTCALC.A5W will create and send an email message if that option 
 is selected. (deactivated in demo). Another option is to pre-build an 
 invoice report and save it. If a report is saved, a button appears that 
 allows the user to open the report in a separate browser window.</p>



<p class=Note><span class=Note><img src="images/icon_information.gif"
									x-maintain-ratio=TRUE
									style="border: none;
											width: 36px;
											height: 32px;
											float: none;
											border-style: none;
											border-style: none;"
									width=36
									height=32
									border=0>Note</span> : Since this page 
 opens within a frameset, any normal <a href="../References/Methods/RESPONSE.REDIRECT Method.html" title="RESPONSE.REDIRECT Method" class="wiki">RESPONSE.REDIRECT(</a>) 
 will just open the page defined in the body section of the frameset. Any 
 redirect must be sent to a special page <a href="FRAMEEXIT.A5W.html" title="FRAMEEXIT.A5W" class="wiki">FRAMEEXIT.A5W</a> 
 that will 'break out' of the frameset. The name of the page to open after 
 the 'break out' must be in the <span class=Code1>pg</span> parameter.</p>



<p class=A5>Links</p>



<p>The <a href="CHECKOUTCOMP.A5W.html" title="CHECKOUTCOMP.A5W" class="wiki">CHECKOUTCOMP.A5W</a> page displays 
 the <a href="../Unclassified/PROCESSING.HTM.html" title="PROCESSING.HTM" class="wiki">PROCESSING.HTM</a> page, which places 
 the CHECKOUTCALC.A5W page in the <span class=Code1>MainFrame</span> section 
 of its frameset.</p>



<p class=Pix><img src="images/ASW_CHECKOUTCALC_A5W.gif"
					x-maintain-ratio=TRUE
					style="width: 728px;
							height: 89px;
							border-left-style: Solid;
							border-left-width: 1px;
							border-right-style: Solid;
							border-right-width: 1px;
							border-top-style: Solid;
							border-top-width: 1px;
							border-bottom-style: Solid;
							border-bottom-width: 1px;
							float: none;"
					width=728
					height=89
					border=1></p>



<p class=PixCaption>CHECKOUTCALC.A5W in the WYSIWYG tab of the HTML Editor 
 </p>



<p class=pixcaption><img src="images/ASW_CHECKOUTCALC_A5W_2.gif"
						x-maintain-ratio=TRUE
						style="border-left-style: Solid;
								border-left-width: 1px;
								border-right-style: Solid;
								border-right-width: 1px;
								border-top-style: Solid;
								border-top-width: 1px;
								border-bottom-style: Solid;
								border-bottom-width: 1px;
								width: 655px;
								height: 75px;
								float: none;"
						width=655
						height=75
						border=1></p>



<p class=PixCaption>CHECKOUTCALC.A5W in the Browser </p>



<p class=A5>Edits to the Page Source</p>



<p>Initially, the page runs the <span class=Code1>sleep(.5)</span> command, 
 which pauses for .5 seconds to give the top frame time to display.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>sleep(.5)</td></tr>
</table>

<p>Next, the page script tests to see if it has received proper values 
 in the calling URL. If the <span class=Code1>cart_id</span> argument is 
 missing or is NULL, control goes back to <a href="CHECKOUTCART.A5W.html" title="CHECKOUTCART.A5W" class="wiki">CHECKOUTCART.A5W</a>.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>if eval_valid("cart_id") = .F.</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>elseif cart_id = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>end if</td></tr>
</table>

<p>Next, the script evaluates the protected variable <span class=Code1>session.<strong>protected</strong>chkoutprogress</span>. 
 If it does not exist, the first checkout page was not completed and control 
 goes back to <a href="CHECKOUTCART.A5W.html" title="CHECKOUTCART.A5W" class="wiki">CHECKOUTCART.A5W</a>. If <span 
 class=Code1>session.<strong>protected</strong>chkoutprogress</span> is less than 3 
 (the last page of checkout), then control goes back to CHECKOUTCART.A5W.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>if eval_valid("session.<strong>protected</strong>chkoutprogress") 
 = .F.</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>elseif session.<strong>protected</strong>chkoutprogress &lt 3</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>end if</td></tr>
</table>

<p>If <span class=Code1>session.<strong>protected</strong>chkout</span> is FALSE (.F.), 
 then no values were passed from page 3 of the checkout and control goes 
 back to CHECKOUTCART.A5W. If <span class=Code1>session.<strong>protected</strong>chkout.first_name</span> 
 is NULL, then the first name field is empty and control goes back to CHECKOUTCART.A5W.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>if eval_valid("session.<strong>protected</strong>chkout") = 
 .F. 'no values passed from page 3</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>elseif session.<strong>protected</strong>chkout.first_name = "" 
 'no values passed from page 3 (first_name was required)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>end if</td></tr>
</table>

<p>The code also moves the protected <span class=Code1>session.<strong>protected</strong>chkout</span> 
 variable to <span class=Code1>chkout_vars</span> before any data processing 
 takes place, such&nbsp;as&nbsp;saving a new customer. Afterwards, it deletes 
 <span class=Code1>session.<strong>protected</strong>chkout</span>.</p>



<p>If the user presses the back button <span class=Bolded>after the protected 
 session variable is deleted</span>, no session variables will exist. If 
 the user clicks submit at this point, he or she will be sent back to the 
 beginning of the check out process.</p>



<p>Next, the page script verifies the user's input. If the customer is 
 new, it saves a new customer record. Then, the code creates an <span class=Code1>invoice_header</span> 
 table record. The items in the shopping cart become records in the <span 
 class=Code1>invoice_items</span> table. Finally, the script sends a confirmation 
 email and/or prints an invoice.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>dim chkout_vars&nbsp;as&nbsp;P</p>


<p class=Code>property_recurse_assign(chkout_vars, session.<strong>protected</strong>chkout)</p>


<p class=Code>delete session.<strong>protected</strong>chkout 'delete session variable</td></tr>
</table>

<p>This section is for an AuthorizeNet transaction. If you are using another 
 type of authorization, remove this section. You must supply some information 
 to AuthorizeNet, including the AuthorizeNet supplied login and transaction 
 key. This data should stored in a secure location - NOT ON THIS PAGE - 
 and added when the page is run. One option is an encrypted text file in 
 the data folder. This text file can be retrieved and decrypted at run 
 time, and the values added to the page.</p>



<p>Example code to create and retrieve a text file is saved in the "SampleAuthorizeNetCode.txt" 
 file in the application database folder.</p>



<p>Create the <span class=Code1>AuthorizeNet_transaction</span> object 
 and set required fields.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'dim x&nbsp;as&nbsp;AuthorizeNet_transaction</p>


<p class=Code>'x.login = "blahblahblah"</p>


<p class=Code>'x.tran_key = "aBcDeFgHiJkLmN"</p>


<p class=Code>'x.amount = alltrim(chkout_vars.total)</p>


<p class=Code>'x.card_num = alltrim(chkout_vars.cc_number)</p>


<p class=Code>'x.exp_date = alltrim(chkout_vars.cc_expire)</p>


<p class=Code>'x.type = "AUTH_CAPTURE"</p>


<p class=Code>'x Include optional billing information, if desired</p>


<p class=Code>'x.first_name = alltrim(chkout_vars.first_name)</p>


<p class=Code>'x.last_name = alltrim(chkout_vars.last_name)</p>


<p class=Code>'x.company = alltrim(chkout_vars.company)</p>


<p class=Code>'x.address = alltrim(chkout_vars.addr1) + " " +alltrim(chkout_vars.addr2)</p>


<p class=Code>'x.city = alltrim(chkout_vars.city)</p>


<p class=Code>'x.state = alltrim(chkout_vars.state)</p>


<p class=Code>'x.zip = alltrim(chkout_vars.zip)</p>


<p class=Code>'x.phone = alltrim(chkout_vars.phone)</td></tr>
</table>

<p>If you wish, include optional additional customer data.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'if alltrim(chkout_vars.customerid) &lt> "" 
 ' existing customer</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;x.cust_id 
 = alltrim(chkout_vars.customerid) 'can be any string up to 20 characters</p>


<p class=Code>'end if</td></tr>
</table>

<p>Configure the email confirmations.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'x.email = alltrim(chkout_vars.email) 'customer email address 
 for transaction confirmation</p>


<p class=Code>'x.email_customer = .t. 'send email confirmation to customer</p>


<p class=Code>'x.merchant_email = "msgboard@alphasoftware.com" 
 'merchant email address for transaction confirmation</td></tr>
</table>

<p>Include optional ship-to information.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'x.ship_to_last_name = alltrim(chkout_vars.ship_to_name)</p>


<p class=Code>'x.ship_to_address = alltrim(chkout_vars.ship_to_address)+" 
 "+alltrim(chkout_vars.saddr2)</p>


<p class=Code>'x.ship_to_city = alltrim(chkout_vars.ship_to_city)</p>


<p class=Code>'x.ship_to_state = alltrim(chkout_vars.ship_to_state)</p>


<p class=Code>'x.ship_to_zip = alltrim(chkout_vars.ship_to_zip)</td></tr>
</table>

<p>Process the transaction. <span class=Code1>x.process()</span> will return 
 TRUE if the transaction server accepted the request and attempted to process 
 the transaction.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'dim result_msg&nbsp;as&nbsp;C</p>


<p class=Code>'result_msg = ""</p>


<p class=Code>'if x.process()then '</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;dim 
 y as P</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;y 
 = x.result</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;result_msg 
 = y.Response_Reason_Text</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;if 
 (y.response_code = "1") &nbsp;&nbsp;&nbsp;&nbsp;' 
 Authorize.Net defines response code 1 as "Approved"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_msg 
 = ""</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;elseif 
 (y.response_code = "2") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Authorize.Net 
 defines response code 2 as "Declined"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_msg 
 = "Transaction Declined"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;elseif 
 (y.response_code = "3") &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Authorize.Net 
 defines response code 3 as "Error"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_msg 
 = "Transaction Error"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;end 
 if</p>


<p class=Code>'else &nbsp;&nbsp;&nbsp;'if 
 x.process()is false, the transaction server could not be contacted or 
 did not respond in a timely manner</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;result_msg 
 = "Transaction could not be completed"</p>


<p class=Code>'end if</td></tr>
</table>

<p>Remove the <span class=Code1>AuthorizeNet_transaction</span> object 
 and respond to any error conditions.</p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>'delete x ' remove AuthorizeNet object</p>


<p class=Code>' If authorize.net transaction fails, show an error message 
 on this page instead of the normal title</p>


<p class=Code>' Stop processing HERE, and send user back to first page 
 in checkout</p>


<p class=Code>'if result_msg &lt> "" ' an error occured</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;page_title 
 = "Processing ERROR - "+result_msg</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;redirect_page 
 = "checkoutcart.a5w"</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;PrintTarget 
 = ""</p>


<p class=Code>' &nbsp;&nbsp;&nbsp;goto 
 run_page ' skip processing section and show page</p>


<p class=Code>'end if</td></tr>
</table>


<p>The next step is to create a new record in the <span class=Code1>invoice_header</span> 
 table. The <span class=Code1>delivery_by</span> value is determined by 
 looking into the <span class=Code1>shipping_types</span> table and filtering 
 on the delivery code stored in <span class=Code1>chkout_vars.delivery_by</span> 
 variable.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>delivery_by = table.external_record_content_get("<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\shipping_types", 
 "alltrim(delivery_by)", "", "ship_code =\"" 
 + alltrim(chkout_vars.delivery_by) + "\"")</p>


<p class=Code>tbl2 = table.open("<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\invoice_header.dbf")</p>


<p class=Code>tbl2.enter_begin()</p>


<p class=Code>tbl2.Customer_id = alltrim(chkout_vars.customerid)</p>


<p class=Code>tbl2.Date = date()</p>


<p class=Code>tbl2.Sales_rep = "Web Sale"</p>


<p class=Code>tbl2.Delivery_by = delivery_by</p>


<p class=Code>tbl2.Pay_method = alltrim(chkout_vars.pay_method)</p>


<p class=Code>tbl2.Sales_tax = 0 ' could populate from table</p>


<p class=Code>tbl2.Discount = 0 ' no discount from web</p>


<p class=Code>' these 2 could be left blank for security reasons</p>


<p class=Code>tbl2.Cc_number = remspecial(chkout_vars.cc_number)</p>


<p class=Code>tbl2.Cc_expiration = alltrim(chkout_vars.cc_expire)</p>


<p class=Code>tbl2.Type = "Web"</p>


<p class=Code>tbl2.Shipping  = chkout_vars.ship_cost</p>


<p class=Code>tbl2.enter_end()</p>


<p class=Code>chkout_vars.invoice_no = tbl2.Invoice_number</p>


<p class=Code>tbl2.close()</td></tr>
</table>

<p>Next, the page script creates invoice lines from the 
 shopping cart and erases entries to indicate that the cart has been used. 
 The current shopping cart is identified by <span class="Code1">cart_id</span> stored in a session cookie.</p>



<p>The invoice lines are saved using a special set definition. 
 This set links the product and specials 
 tables to the <span class="Code1">shop_cart</span> table records with <span class="Code1">product_id</span>. The <span class="Code1">invoice_items</span> table requires a selling price, which can come from either the product 
 or specials tables. If the item is on "special", 
 the price will come from the linked record in the specials 
 table. Otherwise, it comes from the linked record in the product 
 table.</span></p>



<p>First, search for records in this cart by defining 
 <span class="Code1">query.filter</span> and<span class="Code1"> query.order.</span></span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>query.filter = "Cart_Id = \"" + cart_id + 
 "\".and. Quantity > 0"</p>


<p class=Code>query.order = ""</td></tr>
</table>

<p>Open the shop_cart_values 
 set and see how many records there are. If there are no items, return 
 control back to CHECKOUTCART.A5W.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>tbl3 = table.open("<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\shop_cart_values.set")</p>


<p class=Code>qdx = tbl3.query_create()</p>


<p class=Code>if qdx.records_get()= 0</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.close()</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;response.redirect("frameexit.a5w?pg=checkoutcart.a5w")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end</p>


<p class=Code>end if</td></tr>
</table>

<p>Otherwise, open the shop_cart, 
 product, specials, and 
 invoice_items tables.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>tbl4 = table.get("shop_cart")</p>


<p class=Code>tbl5 = table.get("product")</p>


<p class=Code>tbl6 = table.get("specials")</p>


<p class=Code>tbl7 = table.open("<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\invoice_items.dbf")</td></tr>
</table>

<p>Step through the records of the shop_cart_values 
 set and add values to the invoice_items table.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>while .not. tbl3.fetch_eof()</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl7.enter_begin()</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl7.Invoice_number 
 = chkout_vars.invoice_no</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl7.Product_id 
 = tbl4.Prod_Id</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl7.Quantity 
 = tbl4.quantity</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;if 
 tbl6.Sale_Price > 0 .and. (tbl6.Sale_Until >=date().or. cdate(tbl6.Sale_Until) 
 = "") ' product is on special</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tbl7.Price 
 = tbl6.Sale_Price</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;else</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tbl7.Price 
 = tbl5.Retail</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end 
 if</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl7.enter_end()</td></tr>
</table>

<p>Erase the shop_cart_values 
 fields after they are transferred.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.change_begin()'empty 
 values in cart to 'delete' cart</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.cart_id 
 = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.session_id 
 = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.open 
 = .F.</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.Owner_Id 
 = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.change_end()</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;tbl3.fetch_next()</p>


<p class=Code>end while</p>


<p class=Code>tbl3.close()</p>


<p class=Code>tbl7.close()</td></tr>
</table>

<p>Post item sold quantities to the product 
 table with a posting operation. We copied the code from the <span class="Code1">Post_Sales_Quantities</span> operation and modified it.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>a_tbl = table.open("<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\product.dbf")</p>


<p class=Code>post.t_db = "<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\invoice_items.DBF"</p>


<p class=Code>post.m_key = "PRODUCT_ID"</p>


<p class=Code>post.t_key = "PRODUCT_ID"</p>


<p class=Code>post.m_filter = ""</p>


<p class=Code>post.t_filter = "Invoice_Number =\""+alltrim(chkout_vars.invoice_no)+"\""</p>


<p class=Code>post.m_count = 1</p>


<p class=Code>post.m_field1 = "Qty_In_Sto"</p>


<p class=Code>post.m_exp1 = "Qty_In_Sto-@Invoice_Items->Quantity"</p>


<p class=Code>post.t_count = 0</p>


<p class=Code>a_tbl.post()</p>


<p class=Code>a_tbl.close()</td></tr>
</table>

<p>Next, create the body of the email ( email_body 
 ). Note the placeholders "<a class="wiki"  href="invoice_number" rel="">invoice_number</a>" and "<a class="wiki"  href="shipping" rel="">shipping</a>", 
 which will be replaced later.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>email_body = &lt&lt%text%</p>


<p class=Code>Thank you for shopping at Alpha Sports!</p>


<p class=Code>The order below has been charged to your credit card and 
 has been shipped.</p>


<p class=Code>Invoice Number: <a class="wiki"  href="invoice_number" rel="">invoice_number</a></p>


<p class=Code>Shipping Information:</p>


<p class=Code><a class="wiki"  href="shipping" rel="">shipping</a></p>


<p class=Code>For more detail, log in to Alpha Sports and view your Order 
 History.</p>


<p class=Code>%text%</td></tr>
</table>

<p>If the customer selected to receive an email confirmation, 
 the script defines the <span class="Code1">email_subject</span> and <span class="Code1">shipping</span> variables.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>if chkout_vars.confirm_email = "true"</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;email_subject 
 = "Alpha Sports Order Confirmation"</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;shipping 
 = alltrim(chkout_vars.ship_to_name) + crlf()+ alltrim(chkout_vars.ship_to_address)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;if 
 chkout_vars.saddr2 &lt> "" ' second address line</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shipping 
 = shipping + crlf()+ alltrim(chkout_vars.saddr2)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end 
 if</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;shipping 
 = shipping + crlf()+ alltrim(chkout_vars.ship_to_city) + ", " 
 + alltrim(chkout_vars.ship_to_state) + " " + alltrim(chkout_vars.ship_to_zip)</td></tr>
</table>

<p>Replace the place holders in email_body 
 with the invoice number and shipping. Remove 
 the comment marker to use the <a href="../References/Functions/EMAIL_SEND Function.html" title="EMAIL_SEND Function" class="wiki">EMAIL_SEND(</a>) 
 function to actually send the email.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;email_body 
 = stritran(email_body,"<a class="wiki"  href="invoice_number" rel="">invoice_number</a>", alltrim(chkout_vars.invoice_no) )</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;email_body 
 = stritran(email_body,"<a class="wiki"  href="shipping" rel="">shipping</a>",shipping)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;if 
 chkout_vars.email &lt> "" ' verify an email address is available</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' 
 email_send(chkout_vars.email, email_subject, email_body, "", 
 "", "", .F.)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end 
 if</p>


<p class=Code>end if</td></tr>
</table>

<p>If the user requested a printed invoice (actually 
 a PDF file, which he could print), define the PrintTarget, 
 filter, order, and filename variables. Create the PDF with the <a href="../References/Methods/OBJECT.SAVEAS Method.html" title="OBJECT.SAVEAS Method" class="wiki">REPORT.SAVEAS(</a>) 
 method and save the resulting URL in PrintTarget.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>PrintTarget = "" 'target 'page' for report</p>


<p class=Code>if chkout_vars.print_inv = "true"</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;dim 
 filter&nbsp;as&nbsp;C</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;dim 
 order&nbsp;as&nbsp;C</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;Filter 
 = "Invoice_Number = " + quote(alltrim(chkout_vars.invoice_no) )</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;Order 
 = ""</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;dim 
 filename&nbsp;as&nbsp;C</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;filename 
 = session.session_folder + chr(92) + "tempreport.pdf"</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;filename 
 = report.saveas("Invoice@<a class="wiki"  href="PathAlias.ADB_Path" rel="">PathAlias.ADB_Path</a>\invoice.set", 
 "pdf", filter, order, filename, .f.)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;if 
 file.exists(filename)</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintTarget 
 = session.session_url + "tempreport.pdf?" + time("hms3")</p>


<p class=Code>&nbsp;&nbsp;&nbsp;&nbsp;end 
 if</p>


<p class=Code>end if</p>


<p class=Code>redirect_page = "index.a5w"</td></tr>
</table>

<p>After the processing is complete and the page displays, 
 the script tests to see if PrintTarget has a 
 non-null value. If so, the a button appears with the label "Print 
 Your Invoice". Click this label opens the PDF file. Another button 
 with the label "Click Here to Continue" exits from the page 
 and loads <a href="INDEX.A5W.html" title="INDEX.A5W" class="wiki">INDEX.A5W</a>.</span></p>




<table class="htmlTable" style="x-cell-content-align: top;
				border-left-style: None;
				border-right-style: None;
				border-top-style: None;
				border-bottom-style: None;
				width: 100%;
				border-spacing: 0px;
				border-spacing: 0px;" cellspacing="0" width="100%">
<col style="width: 100%;">

<tr style="x-cell-content-align: top;
			width: 100%;
			border-spacing: 0px;
			border-left-style: None;
			border-right-style: None;
			border-top-style: None;
			border-bottom-style: None;" valign="top">
<td style="width: 100%;
			padding-right: 10px;
			padding-left: 10px;" width="100%">
<p class=Code>&lt%a5 if PrintTarget &lt> "" %></p>


<p class=Code><span class=HTML1>&nbsp;&nbsp;&nbsp;&nbsp;&ltinput 
 name="print_inv" type="button" id="print_inv" 
 value="&nbsp;&nbsp;Print Your Invoice&nbsp;&nbsp;" 
 on<x>click="window.open('</span> &lt%a5 ?PrintTarget %> <span class=HTML1>', 
 '', 'status=0, toolbar=0, location=0, menubar=1, resizable=1, scrollbars=1')">&nbsp;&nbsp;</span></p>


<p class=Code>&lt%a5 end if %></p>


<p class=Code><span class=HTML1>&ltinput name="continue" type="button" 
 id="continue" value="Click Here to Continue" on<x>click="window.location='frameexit.a5w?pg=</span> 
 &lt%a5 ?redirect_page %> <span class=HTML1>'"></span></td></tr>
</table>

<p class=A5>Page Security Information</p>



<p>Always Allowed</p>



<p class=A5>See Also</span></p>



<p><a href="../Tutorials/AlphaSportsWeb Explained (Non-Ajax Web)/AlphaSportsWeb Web Pages.html" title="AlphaSportsWeb Web Pages" class="wiki">Web Pages</a></span></p>






<p class=A5></span></p>
	
	
	<hr class="hrwikibottom" /> 

	
	</article> 




	<!-- WIKIPATH:CHECKOUTCALC.A5W">-->


	<div class="wikitopline clearfix" style="clear: both;">
	<div class="content">
				<div class="wikiinfo" style="float: left">



<span id="description"></span>

		</div>

	 
 
	</div> 
</div> 

			</div>
		</div>


	
	
<!-- Put JS at the end -->
	
<!-- jsfile external -->


<!-- jsfile dynamic -->
<!-- jsfile 0 --></body></html>